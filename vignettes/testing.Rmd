---
title: "test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(data.table)
library(sl3)
n <- 250
V <- runif(n, min = -1, max = 1)
W <- runif(n, min = -1, max = 1)
A <- rbinom(n, size = 1, prob = 0.66*plogis(W))
A[A==1] <- 2
A[A==0] <- rbinom(n, size = 1, prob = plogis(W))
table(A)
Y <- rnorm(n, mean = A * (1 + W  ) + W , sd = 0.5)
data <- data.table(W,A,Y)
node_list <- list(W = "W", A = "A", Y = "Y")
learner_list <- list(
  A = Lrnr_pooled_hazards$new(Lrnr_earth$new()),
  Y = Lrnr_earth$new()
)
spec <- tmle3_Spec_npCausalGLM$new(~1+W, treatment_level = 1, estimand = "CATT")
out <- tmle3(spec, data, node_list, learner_list)

spec <- tmle3_Spec_npCausalGLM$new(~1+W, treatment_level = 2, estimand = "CATT")
out1 <- tmle3(spec, data, node_list, learner_list)
out
out1

spec <- tmle3_Spec_npCausalGLM$new(~1+W, treatment_level = 1, estimand = "CATE")
out <- tmle3(spec, data, node_list, learner_list)

spec <- tmle3_Spec_npCausalGLM$new(~1+W, treatment_level = 2, estimand = "CATE")
out1 <- tmle3(spec, data, node_list, learner_list)
out
out1
```

```{r}
library(data.table)
library(sl3)
n <- 250
V <- runif(n, min = -1, max = 1)
W <- runif(n, min = -1, max = 1)
A <- rbinom(n, size = 1, prob = 0.66*plogis(W))
A[A==1] <- 2
A[A==0] <- rbinom(n, size = 1, prob = plogis(W))
table(A)
Y <- rpois(n, lambda = exp( A * (1 + W)  + sin(5 * W)))
data <- data.table(W,A,Y)
node_list <- list(W = "W", A = "A", Y = "Y")
learner_list <- list(
  A = Lrnr_pooled_hazards$new(Lrnr_earth$new()),
  Y = Lrnr_glmnet$new(formula = ~.^2, family = poisson())
)
spec <- tmle3_Spec_npCausalGLM$new(~1+W, estimand = "RR", treatment_level = 1 )
out <- tmle3(spec, data, node_list, learner_list)

spec <- tmle3_Spec_npCausalGLM$new(~1+W, estimand = "RR", treatment_level = 2 )
out1 <- tmle3(spec, data, node_list, learner_list)
out
out1
```

```{r}

 
library(data.table)
library(sl3)
ci <- c()
 
n <- 1000
W <- runif(n, min = -1, max = 1)
Abinary <- rbinom(n ,size = 1, plogis(W))
A <- rgamma(n, shape = 1, rate = exp(W))
A <- A * Abinary
quantile(A)
Y <- rnorm(n, mean = A * (1 + W  ) + W , sd = 0.5)
data <- data.table(W,A,Y)
node_list <- list(W = "W", A = "A", Y = "Y")
learner_list <- list(
  A = Lrnr_gam$new(),
  A_binary = Lrnr_gam$new(),
  Y = Lrnr_stratified$new(Lrnr_gam$new(), variable_stratify = c("A_binary"))
 
)
spec <- tmle3_Spec_contCATE$new(~1+W, ~1)
fit <- tmle3(spec, data, node_list, learner_list)
fit
```


```{r}
tmle_task <- point_tx_continuous_task(data, node_list, include_A_binary = TRUE)
lik <- point_tx_continuous_likelihood(tmle_task, learner_list)
lik <- Targeted_Likelihood$new(lik)
param <- Param_contCATE$new(lik, formula_CATE_binary= ~ 1, formula_CATE_cont = ~ 1 + W)

lik$updater$update(lik,tmle_task)

est <- param$estimates(tmle_task, "validation") 
se <- apply(est$IC,2,sd)
psi <- est$psi
print(psi)
print(apply(est$IC,2,mean))
ci <-  cbind(ci, psi - 1.96 * se / sqrt(n) <= c(0,1,1) &  psi + 1.96 * se / sqrt(n) >= c(0,1,1))
print(apply(ci,1,mean))
}

```


```{r}
est <- param$estimates(tmle_task, "validation") 
apply(est$IC,2,mean)
est$psi
```
